(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[3677],{2221:(e,t,r)=>{Promise.resolve().then(r.bind(r,53898))},12270:(e,t,r)=>{"use strict";var s=Object.defineProperty,a=Object.getOwnPropertyDescriptor,n=Object.getOwnPropertyNames,o=Object.prototype.hasOwnProperty,i=(e,t,r)=>new Promise((s,a)=>{var n=e=>{try{i(r.next(e))}catch(e){a(e)}},o=e=>{try{i(r.throw(e))}catch(e){a(e)}},i=e=>e.done?s(e.value):Promise.resolve(e.value).then(n,o);i((r=r.apply(e,t)).next())}),l={};((e,t)=>{for(var r in t)s(e,r,{get:t[r],enumerable:!0})})(l,{SessionContextProvider:()=>m,useSession:()=>f,useSessionContext:()=>p,useSupabaseClient:()=>h,useUser:()=>v}),e.exports=((e,t,r,i)=>{if(t&&"object"==typeof t||"function"==typeof t)for(let r of n(t))o.call(e,r)||void 0===r||s(e,r,{get:()=>t[r],enumerable:!(i=a(t,r))||i.enumerable});return e})(s({},"__esModule",{value:!0}),l);var u=r(12115),c=r(95155),d=(0,u.createContext)({isLoading:!0,session:null,error:null,supabaseClient:{}}),m=({supabaseClient:e,initialSession:t=null,children:r})=>{let[s,a]=(0,u.useState)(t),[n,o]=(0,u.useState)(!t),[l,m]=(0,u.useState)();(0,u.useEffect)(()=>{!s&&t&&a(t)},[s,t]),(0,u.useEffect)(()=>{let t=!0;return!function(){i(this,null,function*(){let{data:{session:r},error:s}=yield e.auth.getSession();if(t){if(s){m(s),o(!1);return}a(r),o(!1)}})}(),()=>{t=!1}},[]),(0,u.useEffect)(()=>{let{data:{subscription:t}}=e.auth.onAuthStateChange((e,t)=>{t&&("SIGNED_IN"===e||"TOKEN_REFRESHED"===e||"USER_UPDATED"===e)&&a(t),"SIGNED_OUT"===e&&a(null)});return()=>{t.unsubscribe()}},[]);let p=(0,u.useMemo)(()=>n?{isLoading:!0,session:null,error:null,supabaseClient:e}:l?{isLoading:!1,session:null,error:l,supabaseClient:e}:{isLoading:!1,session:s,error:null,supabaseClient:e},[n,s,l]);return(0,c.jsx)(d.Provider,{value:p,children:r})},p=()=>{let e=(0,u.useContext)(d);if(void 0===e)throw Error("useSessionContext must be used within a SessionContextProvider.");return e};function h(){let e=(0,u.useContext)(d);if(void 0===e)throw Error("useSupabaseClient must be used within a SessionContextProvider.");return e.supabaseClient}var f=()=>{let e=(0,u.useContext)(d);if(void 0===e)throw Error("useSession must be used within a SessionContextProvider.");return e.session},v=()=>{var e,t;let r=(0,u.useContext)(d);if(void 0===r)throw Error("useUser must be used within a SessionContextProvider.");return null!=(t=null==(e=r.session)?void 0:e.user)?t:null}},16541:(e,t,r)=>{"use strict";r.r(t),r.d(t,{addToCart:()=>i,clearCart:()=>u,getCart:()=>n,getUserId:()=>a,removeFromCart:()=>l,saveCart:()=>o});var s=r(64983);async function a(){var e;let{data:{session:t}}=await s.supabase.auth.getSession();return(null==t||null==(e=t.user)?void 0:e.id)||null}async function n(){let e=localStorage.getItem("cart"),t=await a();if(!e||!t)return[];try{let r=JSON.parse(e);if(r.userId!==t)return localStorage.removeItem("cart"),[];return r.items||[]}catch(e){return localStorage.removeItem("cart"),[]}}async function o(e){let t=await a();t&&localStorage.setItem("cart",JSON.stringify({userId:t,items:e}))}async function i(e){let t=await n(),r=t.find(t=>t.sku===e.sku);r?r.quantity+=1:t.push({...e,quantity:1}),await o(t)}async function l(e){let t=(await n()).filter(t=>t.sku!==e);await o(t)}async function u(){localStorage.removeItem("cart")}},35695:(e,t,r)=>{"use strict";var s=r(18999);r.o(s,"usePathname")&&r.d(t,{usePathname:function(){return s.usePathname}}),r.o(s,"useRouter")&&r.d(t,{useRouter:function(){return s.useRouter}})},53898:(e,t,r)=>{"use strict";r.r(t),r.d(t,{default:()=>u});var s=r(95155),a=r(12270),n=r(35695),o=r(12115),i=r(16541),l=r(64983);function u(){let e=(0,n.useRouter)(),t=(0,a.useUser)(),[r,u]=(0,o.useState)([]),[c,d]=(0,o.useState)(!0),[m,p]=(0,o.useState)({name:"",phone:"",address:"",payment:"kaspi",delivery:"courier"}),[h,f]=(0,o.useState)(!1);(0,o.useEffect)(()=>{(async()=>{u(await (0,i.getCart)()),d(!1)})()},[]);let v=r.reduce((e,t)=>e+t.price*t.quantity,0),y=e=>{p({...m,[e.target.name]:e.target.value})},x=async s=>{if(s.preventDefault(),!t||!t.id){alert("Вы не вошли в аккаунт"),console.error("user is null or missing id:",t);return}if(0===r.length)return void alert("Корзина пуста");f(!0);let{data:a,error:n}=await l.supabase.from("orders").insert({user_id:t.id,total_amount:v,status:"в обработке",customer_name:m.name,phone:m.phone,address:m.address,payment_method:m.payment,delivery_method:m.delivery}).select().single();if(n){console.error("Ошибка создания заказа:",JSON.stringify(n,null,2)),alert("Ошибка при оформлении заказа"),f(!1);return}let o=a.id,u=r.map(e=>({order_id:o,product_id:e.id,model:e.model,quantity:e.quantity,price:e.price})),{error:c}=await l.supabase.from("order_items").insert(u);if(c){console.error("Ошибка при добавлении товаров:",JSON.stringify(c,null,2)),alert("Ошибка при сохранении товаров заказа"),f(!1);return}(0,i.clearCart)(),localStorage.setItem("last_order_id",o),"kaspi"===m.payment?window.location.href="https://pay.kaspi.kz/pay/p5soibnh":e.push("/client/checkout/success")};return c?(0,s.jsx)("p",{className:"p-6",children:"Загрузка корзины..."}):(0,s.jsxs)("div",{className:"max-w-2xl mx-auto p-4",children:[(0,s.jsx)("h1",{className:"text-2xl font-semibold mb-4",children:"Оформление заказа"}),(0,s.jsxs)("form",{onSubmit:x,className:"space-y-4",children:[(0,s.jsx)("input",{type:"text",name:"name",placeholder:"Имя",value:m.name,onChange:y,required:!0,className:"w-full border px-4 py-2 rounded"}),(0,s.jsx)("input",{type:"tel",name:"phone",placeholder:"Телефон",value:m.phone,onChange:y,required:!0,className:"w-full border px-4 py-2 rounded"}),(0,s.jsx)("input",{type:"text",name:"address",placeholder:"Адрес доставки",value:m.address,onChange:y,required:!0,className:"w-full border px-4 py-2 rounded"}),(0,s.jsxs)("div",{className:"flex gap-4",children:[(0,s.jsxs)("div",{className:"flex flex-col w-1/2",children:[(0,s.jsx)("label",{className:"text-sm mb-1",children:"Доставка"}),(0,s.jsxs)("select",{name:"delivery",value:m.delivery,onChange:y,className:"border px-2 py-1 rounded",children:[(0,s.jsx)("option",{value:"courier",children:"Курьер"}),(0,s.jsx)("option",{value:"pickup",children:"Самовывоз"})]})]}),(0,s.jsxs)("div",{className:"flex flex-col w-1/2",children:[(0,s.jsx)("label",{className:"text-sm mb-1",children:"Оплата"}),(0,s.jsxs)("select",{name:"payment",value:m.payment,onChange:y,className:"border px-2 py-1 rounded",children:[(0,s.jsx)("option",{value:"kaspi",children:"Kaspi"}),(0,s.jsx)("option",{value:"halyk",children:"Halyk"}),(0,s.jsx)("option",{value:"cash",children:"Наличными"})]})]})]}),(0,s.jsx)("button",{type:"submit",disabled:h,className:"w-full text-white py-2 rounded transition ".concat(h?"bg-gray-400":"bg-orange-600 hover:bg-orange-700"),children:h?"Обработка...":"К оплате"})]})]})}},64983:(e,t,r)=>{"use strict";r.r(t),r.d(t,{supabase:()=>s});let s=(0,r(34982).UU)("https://fjzbgaflzavzcwfoozcs.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZqemJnYWZsemF2emN3Zm9vemNzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDczOTM4ODMsImV4cCI6MjA2Mjk2OTg4M30.mTC_-_hacoYgO4gAhXE1A9QoW-V6oS6UNfozzlrh_w4")}},e=>{var t=t=>e(e.s=t);e.O(0,[4982,8441,1684,7358],()=>t(2221)),_N_E=e.O()}]);